<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Elecciones COPASST 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Estilos institucionales -->
  <style>
    :root { --institucional: #0033a0; --secundario: #f5f7fa; }
    body { background: linear-gradient(135deg, var(--institucional) 0%, var(--secundario) 100%); min-height: 100vh; }
    .inst-card { border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; background: white; }
    .inst-button { background: var(--institucional); color: #fff; border: none; border-radius: 50px; padding: 15px 40px; font-weight: bold; }
    .inst-button:hover { background: #002a8b; color: #fff; }
    .certificado-container { background: white; border: 3px solid var(--institucional); border-radius: 15px; padding: 40px; margin-top: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .codigo-verificacion { background: #f8f9fa; padding: 10px 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: bold; letter-spacing: 2px; color: var(--institucional); display: inline-block; margin: 10px 0; }
  </style>
</head>
<body>
<div class="container my-5">
  <div class="card inst-card">
    <div class="card-body text-center p-5">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Logo_UGR.svg/120px-Logo_UGR.svg.png" alt="Logo" class="mb-3" width="120">
      <h1 class="text-primary fw-bold">Elecciones COPASST 2025</h1>
      <p class="text-muted">Sistema de votación institucional</p>

      <!-- LOGIN -->
      <div id="loginBox">
        <button id="loginBtn" class="btn inst-button btn-lg">Entrar con Google</button>
      </div>

      <!-- NO HABILITADO -->
      <div id="notAllowedBox" class="alert alert-warning mt-4" style="display:none">
        Tu cuenta <strong id="rejectedEmail"></strong> <strong>no está habilitada</strong> para votar.
        <button class="btn btn-sm btn-outline-warning ms-2" onclick="auth.signOut()">Cerrar sesión</button>
      </div>

      <!-- YA VOTÓ -->
      <div id="yaVotoBox" class="text-center" style="display:none">
        <div class="alert alert-info">
          <i class="bi bi-check-circle-fill fs-1"></i>
          <h3 class="mt-3">¡Ya votaste!</h3>
          <p class="mb-0">Tu voto fue registrado de forma segura.</p>
        </div>
        <div id="certificado" class="certificado-container"></div>
        <div class="text-center mt-3">
          <button onclick="descargarCertificado()" class="btn inst-button btn-lg">
            <i class="bi bi-download"></i> Descargar certificado en PDF
          </button>
        </div>
      </div>

      <!-- VOTAR -->
      <div id="voteBox" style="display:none">
        <h3 class="text-primary mb-4">Selecciona tu candidato</h3>
        <div id="candidates" class="row g-3"></div>
        <div class="text-center mt-4">
          <button id="btnVotar" class="btn inst-button btn-lg" disabled>Confirmar mi voto</button>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="adminBox" class="text-center mt-4" style="display:none">
        <hr>
        <button id="closeBtn" class="btn btn-danger btn-lg">Cerrar votaciones</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase 12.6.0 modular -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpbdE3QYBpvYbDmrYO8PjFH3rMJkinmwE",
    authDomain: "votacioncopasst-48751.firebaseapp.com",
    projectId: "votacioncopasst-48751",
    storageBucket: "votacioncopasst-48751.firebasestorage.app",
    messagingSenderId: "947307904344",
    appId: "1:947307904344:web:eb62d753c66b816a35f92d"
  };

  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const db       = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const electionId  = 'eleccion2025';
  const electionRef = doc(db, 'elections', electionId);

  // ---------- LOGIN ----------
  document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);

  // ---------- AUTH STATE ----------
  onAuthStateChanged(auth, async user => {
    if (!user) { show('loginBox'); return; }
    hide('loginBox');

    // 1. Crear elección si no existe (solo admin)
    const snap = await getDoc(electionRef);
    if (!snap.exists()) {
      if (user.email === 'alvaro.velez@cali.gov.co') {
        await setDoc(electionRef, {
          open: true,
          candidates: {
            cand1: 'Ana María Pérez',
            cand2: 'Carlos Andrés Ramírez',
            cand3: 'Laura Victoria Gómez'
          },
          adminUID: user.uid,
          votersList: [],
          createdAt: new Date()
        });
      } else {
        alert('La elección aún no ha sido creada por el administrador.');
        return;
      }
    }

    const info = snap.data();

    // 2. ¿Está habilitado?
    if (!info.votersList.includes(user.email)) {
      show('notAllowedBox');
      document.getElementById('rejectedEmail').textContent = user.email;
      return;
    }

    // 3. ¿Ya votó?
    const votoSnap = await getDoc(doc(db, 'elections', electionId, 'votes', user.uid));
    if (votoSnap.exists()) {
      mostrarYaVoto(votoSnap.data());
      return;
    }

    // 4. ¿Votaciones abiertas?
    if (!info.open) {
      showResults(info);
      return;
    }

    // 5. Mostrar candidatos
    show('voteBox');
    if (user.email === 'alvaro.velez@cali.gov.co') show('adminBox');
    drawCandidates(info.candidates);
  });

  // ----------- CANDIDATOS -----------
  function drawCandidates(list) {
    const box = document.getElementById('candidates');
    box.innerHTML = '';
    Object.entries(list).forEach(([id, name]) => {
      const col = document.createElement('div');
      col.className = 'col-md-4';
      col.innerHTML =
        `<div class="candidato-card text-center p-3" onclick="selectCandidate('${id}', '${name}', this)">
           <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=250&background=667eea&color=fff" class="img-fluid rounded mb-2" style="height:200px;object-fit:cover;">
           <h5 class="text-primary fw-bold">${name}</h5>
         </div>`;
      box.appendChild(col);
    });
  }

  let selectedId = null, selectedName = null;
  function selectCandidate(id, name, card) {
    document.querySelectorAll('.candidato-card').forEach(c => c.classList.remove('border', 'border-3', 'border-primary'));
    card.classList.add('border', 'border-3', 'border-primary');
    selectedId = id;
    selectedName = name;
    document.getElementById('btnVotar').disabled = false;
  }

  // ----------- VOTAR (guarda los 4 campos) -----------
  document.getElementById('btnVotar').onclick = async () => {
    if (!selectedId) return;
    if (!confirm(`¿Confirmas tu voto?`)) return;

    const user   = auth.currentUser;
    const uid    = user.uid;
    const fecha  = new Date().toLocaleString('es-CO'); // 19/11/2025 18:37:15
    const codigo = Math.random().toString(36).slice(-8).toUpperCase(); // ZS5PZXQU

    // 1. Guardar voto con Email, Candidato, Fecha y Código único
    await setDoc(doc(db, 'elections', electionId, 'votes', uid), {
      email: user.email,
      candidato: selectedName,
      fecha: fecha,
      codigoVerificacion: codigo
    });

    // 2. Mostrar pantalla "Ya votaste" + certificado
    mostrarYaVoto({ email: user.email, fecha: fecha, codigoVerificacion: codigo });

    // 3. Descarga automática del certificado
    await generarCertificado(fecha, codigo);
  };

  // ----------- MOSTRAR "YA VOTÓ" + CERTIFICADO -----------
  function mostrarYaVoto(voto) {
    hide('voteBox'); hide('adminBox'); hide('loginBox'); hide('notAllowedBox');
    show('yaVotoBox');

    const html = `
      <div class="certificado-container">
        <div class="text-center mb-4">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Logo_UGR.svg/120px-Logo_UGR.svg.png" width="80">
          <h3 class="text-primary fw-bold mt-2">CERTIFICADO DE VOTO</h3>
        </div>
        <div class="text-center">
          <p>La institución certifica que:</p>
          <h4 class="text-primary fw-bold">${voto.email}</h4>
          <p><strong>Fecha y hora:</strong> ${voto.fecha}</p>
          <div style="margin-top: 30px;">
            <p><strong>Código de verificación:</strong></p>
            <div class="codigo-verificacion">${voto.codigoVerificacion}</div>
          </div>
          <p class="mt-3 mb-0" style="font-size:0.85rem;color:#666;">Este documento tiene validez institucional.</p>
        </div>
      </div>`;
    document.getElementById('certificado').innerHTML = html;
  }

  // ----------- CERRAR VOTACIONES -----------
  document.getElementById('closeBtn').onclick = async () => {
    if (!confirm('¿Seguro de cerrar las votaciones?')) return;
    try {
      await updateDoc(electionRef, { open: false });
      alert('Votaciones cerradas. Recarga para ver resultados.');
      location.reload();
    } catch (e) {
      alert('Error: ' + e.message);
    }
  };

  // ----------- MOSTRAR RESULTADOS -----------
  async function showResults(data) {
    hide('voteBox'); hide('adminBox'); hide('loginBox'); hide('notAllowedBox'); hide('yaVotoBox');
    show('resultBox');

    const votesSnap = await getDocs(collection(db, 'elections', electionId, 'votes'));
    const tally = {};
    Object.keys(data.candidates).forEach(id => tally[id] = 0);
    votesSnap.forEach(d => {
      const c = d.data().candidato;
      tally[c] = (tally[c] || 0) + 1;
    });

    const sorted = Object.entries(tally).sort((a, b) => b[1] - a[1]);
    const winnerName = sorted[0][0];
    document.getElementById('winner').textContent =
      `Ganador: ${winnerName} con ${sorted[0][1]} voto(s)`;

    // Gráfico de barras
    const nombres = sorted.map(([name]) => name);
    const votos   = sorted.map(([, n]) => n);
    new Chart(document.getElementById('graficoBarras'), {
      type: 'bar',
      data: {
        labels: nombres,
        datasets: [{ data: votos, backgroundColor: 'rgba(0, 51, 160, 0.8)', borderRadius: 8 }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
    });

    // Certificado genérico de participación
    generarCertificadoParticipacion();
  }

  function generarCertificadoParticipacion() {
    const html = `
      <div class="certificado-container">
        <div class="text-center mb-4">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Logo_UGR.svg/120px-Logo_UGR.svg.png" width="80">
          <h3 class="text-primary fw-bold mt-2">CERTIFICADO DE PARTICIPACIÓN</h3>
        </div>
        <div class="text-center">
          <p>El proceso electoral ha finalizado exitosamente.</p>
          <p><strong>Fecha y hora:</strong> ${new Date().toLocaleString('es-CO')}</p>
          <p class="mt-3 mb-0" style="font-size:0.85rem;color:#666;">Documento generado automáticamente.</p>
        </div>
      </div>`;
    document.getElementById('certificado').innerHTML = html;
  }

  function descargarCertificado() {
    const cert = document.getElementById('certificado');
    html2canvas(cert, { scale: 2, backgroundColor: '#fff' }).then(canvas => {
      const pdf = new jsPDF('p', 'mm', 'a4');
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 180;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      pdf.addImage(imgData, 'PNG', 15, 10, imgWidth, imgHeight);
      pdf.save('Certificado_Votacion_COPASST2025.pdf');
    });
  }

  // ----------- HELPERS -----------
  function show(id) { document.getElementById(id).style.display = 'block'; }
  function hide(id) { document.getElementById(id).style.display = 'none'; }

  // ----------- EXPONER FUNCIONES AL GLOBAL -----------
  window.selectCandidate = selectCandidate;
  window.descargarCertificado = descargarCertificado;
</script>

<!-- Librerías auxiliares -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</body>
</html>
