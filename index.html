<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Elecciones COPASST 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"/>
</head>
<body>
<section class="section">
  <div class="container">
    <h1 class="title">Votaciones Institucionales COPASST 2025</h1>

    <!-- LOGIN -->
    <div id="loginBox">
      <button id="loginBtn" class="button is-primary">Entrar con Google</button>
    </div>

    <!-- NO HABILITADO -->
    <div id="notAllowedBox" class="notification is-warning" style="display:none">
      <p>Tu cuenta <b id="rejectedEmail"></b> <strong>no está habilitada</strong> para votar.</p>
      <button class="button is-small" onclick="signOut()">Cerrar sesión</button>
    </div>

    <!-- VOTAR -->
    <div id="voteBox" style="display:none">
      <h2 class="subtitle">Elige a tu candidato:</h2>
      <div id="candidates" class="buttons"></div>
    </div>

    <!-- ADMIN -->
    <div id="adminBox" style="display:none">
      <hr>
      <button id="closeBtn" class="button is-danger">Cerrar votaciones</button>
    </div>

    <!-- RESULTADOS -->
    <div id="resultBox" style="display:none">
      <h2 class="subtitle">Resultados Finales</h2>
      <div id="winner" class="notification is-success"></div>
      <div id="chart" style="width:100%;height:400px"></div>
    </div>
  </div>
</section>

<!-- PLANTILLA CERTIFICADO -->
<div id="cert" style="display:none;width:600px;background:#fff;border:12px solid #0033a0;padding:40px;font-family:Arial">
  <div style="text-align:center">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Logo_UGR.svg/120px-Logo_UGR.svg.png" width="80" alt="Logo">
    <h2 style="margin:10px 0">CERTIFICADO DE VOTO</h2>
    <p>La institución certifica que:</p>
    <h3 id="certName"></h3>
    <p>ha emitido su voto electrónico en las elecciones 2025.</p>
    <table style="margin:20px auto;text-align:left">
      <tr><td><strong>Candidato seleccionado:</strong></td><td id="certCandidate"></td></tr>
      <tr><td><strong>Fecha y hora (UTC):</strong></td><td id="certDate"></td></tr>
      <tr><td><strong>ID único de voto:</strong></td><td id="certHash"></td></tr>
    </table>
    <p style="font-size:12px;color:#555">Este documento tiene validez institucional y puede ser verificado.</p>
  </div>
</div>

<!-- ========= SCRIPTS AL FINAL ========= -->
<!-- Firebase 12.6.0 modular -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpbdE3QYBpvYbDmrYO8PjFH3rMJkinmwE",
    authDomain: "votacioncopasst-48751.firebaseapp.com",
    projectId: "votacioncopasst-48751",
    storageBucket: "votacioncopasst-48751.firebasestorage.app",
    messagingSenderId: "947307904344",
    appId: "1:947307904344:web:eb62d753c66b816a35f92d",
    measurementId: "G-YZ244EDSPS"
  };

  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const db       = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const electionId  = 'eleccion2025';
  const electionRef = doc(db, 'elections', electionId);

  // ----------- LOGIN -----------
  document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);

  // ----------- AUTH STATE -----------
  onAuthStateChanged(auth, async user => {
    if (!user) { show('loginBox'); return; }
    hide('loginBox');

    const snap = await getDoc(electionRef);
    if (!snap.exists()) {
      if (user.email === 'alvaro.velez@cali.gov.co') {
        await setDoc(electionRef, {
          open: true,
          candidates: {
            cand1: 'Candidato 1',
            cand2: 'Candidato 2',
            cand3: 'Candidato 3'
          },
          adminUID: user.uid,
          votersList: [],
          createdAt: new Date()
        });
      } else {
        alert('La elección aún no ha sido creada por el administrador.');
        return;
      }
    }

    const info = snap.data();
    if (!info.votersList.includes(user.email)) {
      show('notAllowedBox');
      document.getElementById('rejectedEmail').textContent = user.email;
      return;
    }
    if (!info.open) { showResults(info); return; }

    show('voteBox');
    if (user.email === 'alvaro.velez@cali.gov.co') show('adminBox');
    drawCandidates(info.candidates);
  });

  // ----------- DIBUJAR CANDIDATOS -----------
  function drawCandidates(list) {
    const box = document.getElementById('candidates');
    box.innerHTML = '';
    Object.entries(list).forEach(([id, name]) => {
      const btn = document.createElement('button');
      btn.className = 'button is-medium is-fullwidth';
      btn.textContent = name;
      btn.onclick = () => vote(id, name);
      box.appendChild(btn);
    });
  }

  // ----------- VOTAR -----------
  async function vote(candidateId, candidateName) {
    const uid = auth.currentUser.uid;
    await setDoc(doc(db, 'elections', electionId, 'votes', uid), {
      candidateId,
      ts: new Date()
    });
    await generarCertificado(candidateName);
    alert('¡Voto registrado! Tu certificado se ha descargado.');
    location.reload();
  }

  // ----------- CERTIFICADO PDF -----------
  async function generarCertificado(candidateName) {
    const user = auth.currentUser;
    const ts   = new Date().toISOString();
    const hash = btoa(user.uid + ts).slice(-12);
    document.getElementById('certName').textContent      = user.displayName;
    document.getElementById('certCandidate').textContent = candidateName;
    document.getElementById('certDate').textContent      = ts;
    document.getElementById('certHash').textContent      = hash;
    const cert = document.getElementById('cert');
    cert.style.display = 'block';
    const canvas = await html2canvas(cert, { scale: 2, backgroundColor: '#fff' });
    cert.style.display = 'none';
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgData   = canvas.toDataURL('image/png');
    const imgWidth  = 180;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 15, 10, imgWidth, imgHeight);
    pdf.save(`Certificado_Voto_${user.uid.slice(-6)}.pdf`);
  }

  // ----------- CERRAR VOTACIONES -----------
  document.getElementById('closeBtn').onclick = async () => {
    if (!confirm('¿Seguro de cerrar las votaciones?')) return;
    try {
      await updateDoc(electionRef, { open: false });
      alert('Votaciones cerradas.');
      location.reload();
    } catch (e) {
      alert('Error: ' + e.message);
    }
  };

  // ----------- MOSTRAR RESULTADOS -----------
  async function showResults(data) {
    hide('voteBox'); hide('adminBox'); show('resultBox');
    const votesSnap = await getDocs(collection(db, 'elections', electionId, 'votes'));
    const tally = {};
    Object.keys(data.candidates).forEach(id => tally[id] = 0);
    votesSnap.forEach(d => {
      const c = d.data().candidateId;
      tally[c] = (tally[c] || 0) + 1;
    });
    const sorted = Object.entries(tally).sort((a, b) => b[1] - a[1]);
    const winnerId = sorted[0][0];
    document.getElementById('winner').textContent =
      `Ganador: ${data.candidates[winnerId]} con ${sorted[0][1]} voto(s)`;
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(() => {
      const arr = [['Candidato', 'Votos']];
      sorted.forEach(([id, n]) => arr.push([data.candidates[id], n]));
      const dt = google.visualization.arrayToDataTable(arr);
      new google.visualization.ColumnChart(document.getElementById('chart'))
        .draw(dt, { title: 'Votación' });
    });
  }

  // ----------- HELPERS -----------
  function show(el) { el.style.display = 'block'; }
  function hide(el) { el.style.display = 'none'; }

  // ----------- CERRAR SESIÓN ----------
  window.signOut = () => auth.signOut();
</script>

<!-- Librerías auxiliares -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
</body>
</html>
